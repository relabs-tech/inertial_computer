<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inertial Computer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05060a;
      --card-bg: #15171c;
      --text: #e5e5e5;
      --muted: #999;
      --accent: #4fc3f7;
      --label: #c586c0;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #10131a 0, #05060a 45%, #000 100%);
      color: var(--text);
    }

    .page {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 0.5rem 1rem 1rem;
    }

    .app {
      width: 100%;
      max-width: 1600px;
    }

    h1 {
      margin: 0 0 0.5rem;
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      color: var(--accent);
    }

    .subtitle {
      text-align: center;
      margin-bottom: 0.8rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.8rem;
      align-items: stretch;
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 140px;
    }

    h2 {
      margin: 0 0 0.5rem;
      font-size: 0.95rem;
      color: var(--accent);
    }

    .value-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      margin: 0.1rem 0;
    }

    .label {
      color: var(--label);
    }

    .value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
    }

    .unit {
      margin-left: 0.2rem;
      color: var(--muted);
      font-weight: 400;
    }

    .status {
      margin-top: 0.5rem;
      font-size: 0.7rem;
      color: var(--muted);
    }

    /* Satellite sky plot */
    .sat-card {
      grid-column: span 2;
      min-height: 280px;
    }

    #satCanvas {
      width: 100%;
      height: 240px;
      display: block;
      margin-top: 0.5rem;
    }

    /* Satellite signal strength bar chart */
    .sat-bar-card {
      grid-column: span 2;
      min-height: 280px;
    }

    #satBarCanvas {
      width: 100%;
      height: 240px;
      display: block;
      margin-top: 0.5rem;
    }

    @media (max-width: 768px) {
      .sat-card, .sat-bar-card {
        grid-column: 1 / -1;
      }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }

    .header-left {
      flex: 1;
    }

    .cal-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }

    .cal-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .cal-button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="app">
      <div class="header">
        <div class="header-left">
          <h1>Inertial Computer (MQTT Data)</h1>
          <div class="subtitle">Live data from dual IMUs, BMPs, GPS with left/right/fused orientation</div>
        </div>
        <button class="cal-button" onclick="window.location.href='/calibration.html'">
          ðŸŽ¯ Calibrate IMU
        </button>
      </div>

      <div class="grid">
        <!-- Left IMU Orientation -->
        <div class="card">
          <h2>Left Pose</h2>
          <div class="value-row">
            <div class="label">Roll</div>
            <div class="value"><span id="left-roll">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="value-row">
            <div class="label">Pitch</div>
            <div class="value"><span id="left-pitch">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="value-row">
            <div class="label">Yaw</div>
            <div class="value"><span id="left-yaw">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="status" id="leftStatus">Left: connectingâ€¦</div>
        </div>

        <!-- Right IMU Orientation -->
        <div class="card">
          <h2>Right Pose</h2>
          <div class="value-row">
            <div class="label">Roll</div>
            <div class="value"><span id="right-roll">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="value-row">
            <div class="label">Pitch</div>
            <div class="value"><span id="right-pitch">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="value-row">
            <div class="label">Yaw</div>
            <div class="value"><span id="right-yaw">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="status" id="rightStatus">Right: connectingâ€¦</div>
        </div>

        <!-- Fused Orientation -->
        <div class="card">
          <h2>Fused Pose</h2>
          <div class="value-row">
            <div class="label">Roll</div>
            <div class="value"><span id="fuse-roll">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="value-row">
            <div class="label">Pitch</div>
            <div class="value"><span id="fuse-pitch">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="value-row">
            <div class="label">Yaw</div>
            <div class="value"><span id="fuse-yaw">0.00</span><span class="unit">deg</span></div>
          </div>
          <div class="status" id="fuseStatus">Fused: connectingâ€¦</div>
        </div>

        <!-- GPS -->
        <div class="card">
          <h2>GPS</h2>
          <div class="value-row"><div class="label">Lat</div><div class="value"><span id="gps-lat">--</span></div></div>
          <div class="value-row"><div class="label">Lon</div><div class="value"><span id="gps-lon">--</span></div></div>
          <div class="value-row"><div class="label">Alt</div><div class="value"><span id="gps-alt">--</span><span class="unit">m</span></div></div>
          <div class="value-row"><div class="label">Speed</div><div class="value"><span id="gps-speed">0.0</span><span class="unit">kn</span></div></div>
          <div class="value-row"><div class="label">Course</div><div class="value"><span id="gps-course">0.0</span><span class="unit">deg</span></div></div>
          <div class="value-row"><div class="label">Fix</div><div class="value" id="gps-fix">--</div></div>
          <div class="value-row"><div class="label">Sats</div><div class="value"><span id="gps-sats">--</span></div></div>
          <div class="value-row"><div class="label">HDOP</div><div class="value"><span id="gps-hdop">--</span></div></div>
          <div class="status" id="gpsStatus">GPS: connectingâ€¦</div>
        </div>

        <!-- Satellite Sky Plot -->
        <div class="card sat-card">
          <h2>Satellites in View</h2>
          <canvas id="satCanvas"></canvas>
          <div class="status" id="satStatus">Satellites: connectingâ€¦</div>
        </div>

        <!-- Satellite Signal Strength Bar Chart -->
        <div class="card sat-bar-card">
          <h2>Satellite Signal Strength</h2>
          <canvas id="satBarCanvas"></canvas>
          <div class="status" id="satBarStatus">Signal strength: connectingâ€¦</div>
        </div>

        <!-- Left IMU -->
        <div class="card">
          <h2>Left IMU (raw)</h2>
          <div class="value-row"><div class="label">Ax</div><div class="value"><span id="imu-left-ax">0</span></div></div>
          <div class="value-row"><div class="label">Ay</div><div class="value"><span id="imu-left-ay">0</span></div></div>
          <div class="value-row"><div class="label">Az</div><div class="value"><span id="imu-left-az">0</span></div></div>
          <div class="value-row"><div class="label">Gx</div><div class="value"><span id="imu-left-gx">0</span></div></div>
          <div class="value-row"><div class="label">Gy</div><div class="value"><span id="imu-left-gy">0</span></div></div>
          <div class="value-row"><div class="label">Gz</div><div class="value"><span id="imu-left-gz">0</span></div></div>
          <div class="value-row"><div class="label">Mx</div><div class="value"><span id="imu-left-mx">0</span></div></div>
          <div class="value-row"><div class="label">My</div><div class="value"><span id="imu-left-my">0</span></div></div>
          <div class="value-row"><div class="label">Mz</div><div class="value"><span id="imu-left-mz">0</span></div></div>
          <div class="status" id="imuLeftStatus">Left IMU: connectingâ€¦</div>
        </div>

        <!-- Right IMU -->
        <div class="card">
          <h2>Right IMU (raw)</h2>
          <div class="value-row"><div class="label">Ax</div><div class="value"><span id="imu-right-ax">0</span></div></div>
          <div class="value-row"><div class="label">Ay</div><div class="value"><span id="imu-right-ay">0</span></div></div>
          <div class="value-row"><div class="label">Az</div><div class="value"><span id="imu-right-az">0</span></div></div>
          <div class="value-row"><div class="label">Gx</div><div class="value"><span id="imu-right-gx">0</span></div></div>
          <div class="value-row"><div class="label">Gy</div><div class="value"><span id="imu-right-gy">0</span></div></div>
          <div class="value-row"><div class="label">Gz</div><div class="value"><span id="imu-right-gz">0</span></div></div>
          <div class="value-row"><div class="label">Mx</div><div class="value"><span id="imu-right-mx">0</span></div></div>
          <div class="value-row"><div class="label">My</div><div class="value"><span id="imu-right-my">0</span></div></div>
          <div class="value-row"><div class="label">Mz</div><div class="value"><span id="imu-right-mz">0</span></div></div>
          <div class="status" id="imuRightStatus">Right IMU: connectingâ€¦</div>
        </div>

        <!-- Left Env -->
        <div class="card">
          <h2>Left Env (BMP)</h2>
          <div class="value-row">
            <div class="label">Temp</div>
            <div class="value"><span id="env-left-temp">0.0</span><span class="unit">Â°C</span></div>
          </div>
          <div class="value-row">
            <div class="label">Pressure</div>
            <div class="value"><span id="env-left-press">0</span><span class="unit">hPa</span></div>
          </div>
          <div class="status" id="envLeftStatus">Left BMP: connectingâ€¦</div>
        </div>

        <!-- Right Env -->
        <div class="card">
          <h2>Right Env (BMP)</h2>
          <div class="value-row">
            <div class="label">Temp</div>
            <div class="value"><span id="env-right-temp">0.0</span><span class="unit">Â°C</span></div>
          </div>
          <div class="value-row">
            <div class="label">Pressure</div>
            <div class="value"><span id="env-right-press">0</span><span class="unit">hPa</span></div>
          </div>
          <div class="status" id="envRightStatus">Right BMP: connectingâ€¦</div>
        </div>

        <!-- Atmospheric Data by GPS Location -->
        <div class="card">
          <h2>Weather @ GPS</h2>
          <div class="value-row">
            <div class="label">Location</div>
            <div class="value"><span id="atm-location">--</span></div>
          </div>
          <div class="value-row">
            <div class="label">GPS</div>
            <div class="value"><span id="atm-coords">--</span></div>
          </div>
          <div class="value-row">
            <div class="label">Temp</div>
            <div class="value"><span id="atm-temp">--</span><span class="unit">Â°C</span></div>
          </div>
          <div class="value-row">
            <div class="label">Pressure</div>
            <div class="value"><span id="atm-press">--</span><span class="unit">hPa</span></div>
          </div>
          <div class="value-row">
            <div class="label">Local SLP</div>
            <div class="value"><span id="atm-local-slp">--</span><span class="unit">hPa</span></div>
          </div>
          <div class="value-row">
            <div class="label">Humidity</div>
            <div class="value"><span id="atm-humidity">--</span><span class="unit">%</span></div>
          </div>
          <div class="value-row">
            <div class="label">Conditions</div>
            <div class="value"><span id="atm-conditions">--</span></div>
          </div>
          <div class="status" id="atmStatus">Weather: waitingâ€¦</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === existing JS, just re-attached to new DOM ===

    // Left Pose
    const leftRollEl = document.getElementById('left-roll');
    const leftPitchEl = document.getElementById('left-pitch');
    const leftYawEl = document.getElementById('left-yaw');
    const leftStatusEl = document.getElementById('leftStatus');

    // Right Pose
    const rightRollEl = document.getElementById('right-roll');
    const rightPitchEl = document.getElementById('right-pitch');
    const rightYawEl = document.getElementById('right-yaw');
    const rightStatusEl = document.getElementById('rightStatus');

    // Fused
    const fuseRollEl = document.getElementById('fuse-roll');
    const fusePitchEl = document.getElementById('fuse-pitch');
    const fuseYawEl = document.getElementById('fuse-yaw');
    const fuseStatusEl = document.getElementById('fuseStatus');

    // GPS
    const gpsLatEl = document.getElementById('gps-lat');
    const gpsLonEl = document.getElementById('gps-lon');
    const gpsAltEl = document.getElementById('gps-alt');
    const gpsSpeedEl = document.getElementById('gps-speed');
    const gpsCourseEl = document.getElementById('gps-course');
    const gpsFixEl = document.getElementById('gps-fix');
    const gpsSatsEl = document.getElementById('gps-sats');
    const gpsHdopEl = document.getElementById('gps-hdop');
    const gpsStatusEl = document.getElementById('gpsStatus');
    const satStatusEl = document.getElementById('satStatus');

    // Satellite sky plot
    const satCanvas = document.getElementById('satCanvas');
    const satCtx = satCanvas.getContext('2d');

    // Satellite bar chart
    const satBarCanvas = document.getElementById('satBarCanvas');
    const satBarCtx = satBarCanvas.getContext('2d');
    const satBarStatusEl = document.getElementById('satBarStatus');

    // IMU left
    const imuLeftAx = document.getElementById('imu-left-ax');
    const imuLeftAy = document.getElementById('imu-left-ay');
    const imuLeftAz = document.getElementById('imu-left-az');
    const imuLeftGx = document.getElementById('imu-left-gx');
    const imuLeftGy = document.getElementById('imu-left-gy');
    const imuLeftGz = document.getElementById('imu-left-gz');
    const imuLeftMx = document.getElementById('imu-left-mx');
    const imuLeftMy = document.getElementById('imu-left-my');
    const imuLeftMz = document.getElementById('imu-left-mz');
    const imuLeftStatus = document.getElementById('imuLeftStatus');

    // IMU right
    const imuRightAx = document.getElementById('imu-right-ax');
    const imuRightAy = document.getElementById('imu-right-ay');
    const imuRightAz = document.getElementById('imu-right-az');
    const imuRightGx = document.getElementById('imu-right-gx');
    const imuRightGy = document.getElementById('imu-right-gy');
    const imuRightGz = document.getElementById('imu-right-gz');
    const imuRightMx = document.getElementById('imu-right-mx');
    const imuRightMy = document.getElementById('imu-right-my');
    const imuRightMz = document.getElementById('imu-right-mz');
    const imuRightStatus = document.getElementById('imuRightStatus');

    // Env left/right
    const envLeftTemp = document.getElementById('env-left-temp');
    const envLeftPress = document.getElementById('env-left-press');
    const envLeftStatus = document.getElementById('envLeftStatus');
    const envRightTemp = document.getElementById('env-right-temp');
    const envRightPress = document.getElementById('env-right-press');
    const envRightStatus = document.getElementById('envRightStatus');

    // Atmospheric @ GPS
    const atmLocation = document.getElementById('atm-location');
    const atmCoords = document.getElementById('atm-coords');
    const atmTemp = document.getElementById('atm-temp');
    const atmPress = document.getElementById('atm-press');
    const atmLocalSLP = document.getElementById('atm-local-slp');
    const atmHumidity = document.getElementById('atm-humidity');
    const atmConditions = document.getElementById('atm-conditions');
    const atmStatus = document.getElementById('atmStatus');

    // Weather API cache - fetch interval loaded from config
    let WEATHER_UPDATE_INTERVAL_MINUTES = 5; // default
    let lastWeatherFetch = 0;
    let cachedWeatherData = null;

    // Load configuration from server
    async function loadConfig() {
      try {
        const res = await fetch('/api/config', { cache: 'no-store' });
        if (res.ok) {
          const config = await res.json();
          WEATHER_UPDATE_INTERVAL_MINUTES = config.weather_update_interval_minutes || 5;
          console.log(`Weather update interval: ${WEATHER_UPDATE_INTERVAL_MINUTES} minutes`);
        }
      } catch (err) {
        console.error('Failed to load config:', err);
      }
    }

    async function fetchLeftOrientation() {
      try {
        const res = await fetch('/api/orientation/left', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        leftRollEl.textContent = (data.roll ?? 0).toFixed(2);
        leftPitchEl.textContent = (data.pitch ?? 0).toFixed(2);
        leftYawEl.textContent = (data.yaw ?? 0).toFixed(2);
        leftStatusEl.textContent = 'Left: live from MQTT';
      } catch (err) {
        leftStatusEl.textContent = 'Left error: ' + err.message;
      }
    }

    async function fetchRightOrientation() {
      try {
        const res = await fetch('/api/orientation/right', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        rightRollEl.textContent = (data.roll ?? 0).toFixed(2);
        rightPitchEl.textContent = (data.pitch ?? 0).toFixed(2);
        rightYawEl.textContent = (data.yaw ?? 0).toFixed(2);
        rightStatusEl.textContent = 'Right: live from MQTT';
      } catch (err) {
        rightStatusEl.textContent = 'Right error: ' + err.message;
      }
    }

    async function fetchFusedOrientation() {
      try {
        const res = await fetch('/api/orientation/fused', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        fuseRollEl.textContent = (data.roll ?? 0).toFixed(2);
        fusePitchEl.textContent = (data.pitch ?? 0).toFixed(2);
        fuseYawEl.textContent = (data.yaw ?? 0).toFixed(2);
        fuseStatusEl.textContent = 'Fused: live from MQTT';
      } catch (err) {
        fuseStatusEl.textContent = 'Fused error: ' + err.message;
      }
    }

    async function fetchGPS() {
      try {
        const res = await fetch('/api/gps', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        gpsLatEl.textContent = (data.lat ?? 0).toFixed(6);
        gpsLonEl.textContent = (data.lon ?? 0).toFixed(6);
        gpsAltEl.textContent = (data.altitude_m ?? 0).toFixed(1);
        gpsSpeedEl.textContent = (data.speed_knots ?? 0).toFixed(1);
        gpsCourseEl.textContent = (data.course_deg ?? 0).toFixed(1);
        gpsFixEl.textContent = data.fix_type || '--';
        
        // Combine GPS and GLONASS satellites
        const gpsSats = data.gps_satellites_in_view || [];
        const glonassSats = data.glonass_satellites_in_view || [];
        const allSats = [...gpsSats, ...glonassSats];
        
        gpsSatsEl.textContent = `${data.num_satellites ?? 0}/${allSats.length}`;
        gpsHdopEl.textContent = (data.hdop ?? 0).toFixed(1);
        gpsStatusEl.textContent = 'GPS: live from MQTT';

        // Draw satellite sky plot with both GPS and GLONASS
        drawSatellites(gpsSats, glonassSats);
        satStatusEl.textContent = `Satellites: ${gpsSats.length} GPS, ${glonassSats.length} GLONASS`;
        
        // Draw satellite signal strength bar chart
        drawSatelliteBarChart(gpsSats, glonassSats);
        satBarStatusEl.textContent = `Signal strength: ${allSats.length} satellites (${gpsSats.length} GPS, ${glonassSats.length} GLONASS)`;
      } catch (err) {
        gpsStatusEl.textContent = 'GPS error: ' + err.message;
        satStatusEl.textContent = 'Satellites error: ' + err.message;
        satBarStatusEl.textContent = 'Signal strength error: ' + err.message;
      }
    }

    function drawSatellites(gpsSatellites, glonassSatellites) {
      const canvas = satCanvas;
      const ctx = satCtx;
      
      // Set canvas size to match display size
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      const width = rect.width;
      const height = rect.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const maxRadius = Math.min(width, height) / 2 - 30;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Draw concentric circles (30Â°, 60Â°, 90Â° elevation)
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 1;
      
      // 90Â° (horizon) - outer
      ctx.beginPath();
      ctx.arc(centerX, centerY, maxRadius, 0, 2 * Math.PI);
      ctx.stroke();
      
      // 60Â° elevation
      ctx.beginPath();
      ctx.arc(centerX, centerY, maxRadius * 2/3, 0, 2 * Math.PI);
      ctx.stroke();
      
      // 30Â° elevation
      ctx.beginPath();
      ctx.arc(centerX, centerY, maxRadius * 1/3, 0, 2 * Math.PI);
      ctx.stroke();

      // Draw crosshairs (N-S, E-W)
      ctx.strokeStyle = '#666';
      ctx.beginPath();
      // Vertical (N-S)
      ctx.moveTo(centerX, centerY - maxRadius);
      ctx.lineTo(centerX, centerY + maxRadius);
      // Horizontal (E-W)
      ctx.moveTo(centerX - maxRadius, centerY);
      ctx.lineTo(centerX + maxRadius, centerY);
      ctx.stroke();

      // Draw labels
      ctx.fillStyle = '#999';
      ctx.font = '12px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // Compass directions (note: not aligned with Pi frame yet)
      ctx.fillText('N', centerX, centerY - maxRadius - 15);
      ctx.fillText('S', centerX, centerY + maxRadius + 15);
      ctx.fillText('E', centerX + maxRadius + 15, centerY);
      ctx.fillText('W', centerX - maxRadius - 15, centerY);

      // Elevation labels
      ctx.fillText('30Â°', centerX + maxRadius * 1/3 + 5, centerY - 5);
      ctx.fillText('60Â°', centerX + maxRadius * 2/3 + 5, centerY - 5);

      // Draw center (zenith)
      ctx.fillStyle = '#666';
      ctx.beginPath();
      ctx.arc(centerX, centerY, 2, 0, 2 * Math.PI);
      ctx.fill();

      // Helper function to draw a satellite
      const drawSat = (sat, isGPS) => {
        const elevation = sat.elevation || 0;
        const azimuth = sat.azimuth || 0;
        const snr = sat.snr || 0;

        // Convert elevation (0-90Â°) to radius (max to 0)
        const radiusRatio = (90 - elevation) / 90;
        const radius = radiusRatio * maxRadius;

        // Convert azimuth to canvas angle
        const angleRad = ((azimuth - 90) * Math.PI) / 180;
        const x = centerX + radius * Math.cos(angleRad);
        const y = centerY + radius * Math.sin(angleRad);

        // Color based on SNR
        let color;
        if (snr === 0) {
          color = '#555';
        } else if (snr < 20) {
          color = '#ff5555';
        } else if (snr < 35) {
          color = '#ffaa00';
        } else {
          color = '#55ff55';
        }

        ctx.fillStyle = color;
        if (isGPS) {
          // GPS: circles
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, 2 * Math.PI);
          ctx.fill();
        } else {
          // GLONASS: squares
          ctx.fillRect(x - 6, y - 6, 12, 12);
        }

        // Draw satellite number
        ctx.fillStyle = '#fff';
        ctx.font = '10px system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(sat.sv_number || '?', x, y);
      };

      // Draw GPS satellites (circles)
      gpsSatellites.forEach(sat => drawSat(sat, true));
      
      // Draw GLONASS satellites (squares)
      glonassSatellites.forEach(sat => drawSat(sat, false));

      // Draw legend
      ctx.font = '11px system-ui';
      ctx.textAlign = 'left';
      let legendY = height - 25;
      
      // Signal strength legend
      ctx.fillStyle = '#55ff55';
      ctx.fillRect(10, legendY - 8, 12, 12);
      ctx.fillStyle = '#999';
      ctx.fillText('Strong (>35dB)', 25, legendY);
      
      ctx.fillStyle = '#ffaa00';
      ctx.fillRect(120, legendY - 8, 12, 12);
      ctx.fillStyle = '#999';
      ctx.fillText('Moderate', 135, legendY);
      
      ctx.fillStyle = '#ff5555';
      ctx.fillRect(210, legendY - 8, 12, 12);
      ctx.fillStyle = '#999';
      ctx.fillText('Weak', 225, legendY);
      
      // Constellation legend
      legendY = height - 10;
      ctx.fillStyle = '#4fc3f7';
      ctx.beginPath();
      ctx.arc(16, legendY - 2, 6, 0, 2 * Math.PI);
      ctx.fill();
      ctx.fillStyle = '#999';
      ctx.fillText('GPS', 25, legendY);
      
      ctx.fillStyle = '#4fc3f7';
      ctx.fillRect(70, legendY - 8, 12, 12);
      ctx.fillStyle = '#999';
      ctx.fillText('GLONASS', 85, legendY);
    }

    function drawSatelliteBarChart(gpsSatellites, glonassSatellites) {
      const canvas = satBarCanvas;
      const ctx = satBarCtx;
      
      // Set canvas size to match display size
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      const width = rect.width;
      const height = rect.height;
      const padding = 40;
      const chartWidth = width - 2 * padding;
      const chartHeight = height - 2 * padding;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Combine and tag satellites with constellation type
      const taggedGPS = gpsSatellites.map(sat => ({ ...sat, constellation: 'GPS' }));
      const taggedGLONASS = glonassSatellites.map(sat => ({ ...sat, constellation: 'GLONASS' }));
      const allSats = [...taggedGPS, ...taggedGLONASS];

      if (allSats.length === 0) {
        ctx.fillStyle = '#999';
        ctx.font = '14px system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('No satellites in view', width / 2, height / 2);
        return;
      }

      // Sort satellites by PRN for consistent display
      const sortedSats = allSats.sort((a, b) => (a.sv_number || 0) - (b.sv_number || 0));

      const barWidth = Math.max(15, Math.min(40, chartWidth / sortedSats.length - 4));
      const spacing = Math.max(2, (chartWidth - barWidth * sortedSats.length) / (sortedSats.length + 1));

      // Draw axes
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      
      // Y-axis
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.stroke();
      
      // X-axis
      ctx.beginPath();
      ctx.moveTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();

      // Y-axis labels and grid lines
      ctx.fillStyle = '#999';
      ctx.font = '11px system-ui';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      ctx.strokeStyle = '#333';
      
      const yLabels = [0, 20, 40, 60, 80, 99];
      yLabels.forEach(val => {
        const y = height - padding - (val / 99) * chartHeight;
        ctx.fillText(`${val}dB`, padding - 5, y);
        
        // Grid line
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      });

      // Draw bars for each satellite
      sortedSats.forEach((sat, idx) => {
        const snr = sat.snr || 0;
        const barHeight = (snr / 99) * chartHeight;
        const isGPS = sat.constellation === 'GPS';
        const x = padding + spacing + idx * (barWidth + spacing);
        const y = height - padding - barHeight;

        // Color based on SNR
        let color;
        if (snr === 0) {
          color = '#555'; // Not tracked
        } else if (snr < 20) {
          color = '#ff5555'; // Weak
        } else if (snr < 35) {
          color = '#ffaa00'; // Moderate
        } else {
          color = '#55ff55'; // Strong
        }

        // Draw bar
        ctx.fillStyle = color;
        ctx.fillRect(x, y, barWidth, barHeight);

        // Draw constellation indicator at top of bar
        ctx.fillStyle = isGPS ? '#4fc3f7' : '#c586c0';
        const markerSize = 4;
        if (isGPS) {
          // GPS: small circle
          ctx.beginPath();
          ctx.arc(x + barWidth / 2, y + markerSize + 2, markerSize, 0, 2 * Math.PI);
          ctx.fill();
        } else {
          // GLONASS: small square
          ctx.fillRect(x + barWidth / 2 - markerSize, y + 2, markerSize * 2, markerSize * 2);
        }

        // Draw border
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, barWidth, barHeight);

        // Draw PRN number below bar
        ctx.fillStyle = '#ccc';
        ctx.font = '10px system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(sat.sv_number || '?', x + barWidth / 2, height - padding + 5);

        // Draw SNR value on top of bar (if bar is tall enough)
        if (snr > 0 && barHeight > 20) {
          ctx.fillStyle = '#000';
          ctx.font = 'bold 10px system-ui';
          ctx.textBaseline = 'bottom';
          ctx.fillText(snr, x + barWidth / 2, y - 2);
        }
      });

      // Chart title
      ctx.fillStyle = '#4fc3f7';
      ctx.font = '12px system-ui';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'bottom';
      ctx.fillText('Signal-to-Noise Ratio (dB)', padding, padding - 5);
    }

    async function fetchIMULeft() {
      try {
        const res = await fetch('/api/imu/left', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const d = await res.json();
        imuLeftAx.textContent = d.ax ?? 0;
        imuLeftAy.textContent = d.ay ?? 0;
        imuLeftAz.textContent = d.az ?? 0;
        imuLeftGx.textContent = d.gx ?? 0;
        imuLeftGy.textContent = d.gy ?? 0;
        imuLeftGz.textContent = d.gz ?? 0;
        imuLeftMx.textContent = d.mx ?? 0;
        imuLeftMy.textContent = d.my ?? 0;
        imuLeftMz.textContent = d.mz ?? 0;
        imuLeftStatus.textContent = 'Left IMU: live from MQTT';
      } catch (err) {
        imuLeftStatus.textContent = 'Left IMU error: ' + err.message;
      }
    }

    async function fetchIMURight() {
      try {
        const res = await fetch('/api/imu/right', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const d = await res.json();
        imuRightAx.textContent = d.ax ?? 0;
        imuRightAy.textContent = d.ay ?? 0;
        imuRightAz.textContent = d.az ?? 0;
        imuRightGx.textContent = d.gx ?? 0;
        imuRightGy.textContent = d.gy ?? 0;
        imuRightGz.textContent = d.gz ?? 0;
        imuRightMx.textContent = d.mx ?? 0;
        imuRightMy.textContent = d.my ?? 0;
        imuRightMz.textContent = d.mz ?? 0;
        imuRightStatus.textContent = 'Right IMU: live from MQTT';
      } catch (err) {
        imuRightStatus.textContent = 'Right IMU error: ' + err.message;
      }
    }

    async function fetchEnvLeft() {
      try {
        const res = await fetch('/api/env/left', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const d = await res.json();
        envLeftTemp.textContent = (d.temp_c ?? 0).toFixed(1);
        envLeftPress.textContent = ((d.pressure_pa ?? 0) / 100).toFixed(1);
        envLeftStatus.textContent = 'Left BMP: live from MQTT';
      } catch (err) {
        envLeftStatus.textContent = 'Left BMP error: ' + err.message;
      }
    }

    async function fetchEnvRight() {
      try {
        const res = await fetch('/api/env/right', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const d = await res.json();
        envRightTemp.textContent = (d.temp_c ?? 0).toFixed(1);
        envRightPress.textContent = ((d.pressure_pa ?? 0) / 100).toFixed(1);
        envRightStatus.textContent = 'Right BMP: live from MQTT';
      } catch (err) {
        envRightStatus.textContent = 'Right BMP error: ' + err.message;
      }
    }

    async function fetchAtmospheric() {
      try {
        // Get GPS position
        const gpsRes = await fetch('/api/gps', { cache: 'no-store' });
        if (!gpsRes.ok) throw new Error('GPS HTTP ' + gpsRes.status);
        const gpsData = await gpsRes.json();

        const lat = gpsData.lat ?? 0;
        const lon = gpsData.lon ?? 0;
        const alt = gpsData.altitude_m ?? 0;

        // Check if we have valid GPS data
        if (lat === 0 && lon === 0) {
          atmStatus.textContent = 'Weather: waiting for GPS fix';
          return;
        }

        // Get local pressure from BMP sensors
        const [leftRes, rightRes] = await Promise.all([
          fetch('/api/env/left', { cache: 'no-store' }),
          fetch('/api/env/right', { cache: 'no-store' })
        ]);

        let localPressureHPa = null;
        let count = 0, sumPress = 0;

        if (leftRes.ok) {
          const left = await leftRes.json();
          if (left.pressure_pa != null) {
            sumPress += left.pressure_pa / 100; // convert to hPa
            count++;
          }
        }

        if (rightRes.ok) {
          const right = await rightRes.json();
          if (right.pressure_pa != null) {
            sumPress += right.pressure_pa / 100; // convert to hPa
            count++;
          }
        }

        if (count > 0) {
          localPressureHPa = sumPress / count;
          // Calculate sea level pressure using barometric formula
          // P0 = P * (1 - (0.0065 * h) / (T + 0.0065 * h + 273.15))^-5.257
          // Simplified: P0 = P * (1 - h/44330)^-5.255
          const localSLP = localPressureHPa * Math.pow(1 - alt / 44330, -5.255);
          atmLocalSLP.textContent = localSLP.toFixed(1);
        } else {
          atmLocalSLP.textContent = '--';
        }

        // Check if we need to fetch new weather data (throttle API calls)
        const now = Date.now();
        const intervalMs = WEATHER_UPDATE_INTERVAL_MINUTES * 60 * 1000;
        const shouldFetch = !cachedWeatherData || (now - lastWeatherFetch) >= intervalMs;

        if (shouldFetch) {
          // Fetch weather data from met.no
          const weatherUrl = `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}&altitude=${Math.round(alt)}`;
          const weatherRes = await fetch(weatherUrl, {
            headers: {
              'User-Agent': 'InertialComputer/1.0 github.com/relabs-tech/inertial_computer'
            }
          });
          
          if (!weatherRes.ok) {
            throw new Error('Met.no API HTTP ' + weatherRes.status);
          }

          const weatherData = await weatherRes.json();
          
          // Get current conditions from first timeseries entry
          const current = weatherData.properties?.timeseries?.[0];
          if (!current) {
            throw new Error('No weather data available');
          }

          const instant = current.data?.instant?.details;
          const next1h = current.data?.next_1_hours;

          // Cache the weather data
          cachedWeatherData = { instant, next1h, lat, lon, alt };
          lastWeatherFetch = now;
        }

        // Use cached data for display
        if (cachedWeatherData) {
          const { instant, next1h, lat: cachedLat, lon: cachedLon, alt: cachedAlt } = cachedWeatherData;
          
          // Update display
          const latDir = cachedLat >= 0 ? 'N' : 'S';
          const lonDir = cachedLon >= 0 ? 'E' : 'W';
          atmLocation.textContent = `${Math.abs(cachedLat).toFixed(2)}Â°${latDir}, ${Math.abs(cachedLon).toFixed(2)}Â°${lonDir}`;
          atmCoords.textContent = `Alt: ${Math.round(cachedAlt)}m`;
          
          // Ensure temperature is treated as a number and format with 2 decimals
          const temp = parseFloat(instant?.air_temperature);
          atmTemp.textContent = !isNaN(temp) ? temp.toFixed(2) : '--';
          
          const press = parseFloat(instant?.air_pressure_at_sea_level);
          atmPress.textContent = !isNaN(press) ? press.toFixed(1) : '--';
          
          const humid = parseFloat(instant?.relative_humidity);
          atmHumidity.textContent = !isNaN(humid) ? humid.toFixed(1) : '--';
          
          atmConditions.textContent = next1h?.summary?.symbol_code?.replace(/_/g, ' ') || '--';
          
          // Show time since last fetch
          const minsSinceUpdate = Math.floor((Date.now() - lastWeatherFetch) / 60000);
          atmStatus.textContent = minsSinceUpdate === 0 ? 'Weather: live from met.no' : `Weather: ${minsSinceUpdate}m ago`;
        }
      } catch (err) {
        atmStatus.textContent = 'Weather error: ' + err.message;
      }
    }

    function tick() {
      fetchLeftOrientation();
      fetchRightOrientation();
      fetchFusedOrientation();
      fetchGPS();
      fetchIMULeft();
      fetchIMURight();
      fetchEnvLeft();
      fetchEnvRight();
      fetchAtmospheric();
    }

    // Load config then start polling
    loadConfig().then(() => {
      setInterval(tick, 500);
      tick();
    });
  </script>
</body>
</html>
