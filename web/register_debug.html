<!--
  Copyright (c) 2026 Daniel Alarcon Rubio / Relabs Tech
  SPDX-License-Identifier: MIT
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPU9250 Register Debugger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            margin-bottom: 30px;
            border-bottom: 2px solid #30363d;
            padding-bottom: 20px;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #79c0ff;
        }

        .header-info {
            font-size: 0.9em;
            color: #8b949e;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .control-panel h3 {
            color: #79c0ff;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .imu-selector {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #c9d1d9;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #e6edf3;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #79c0ff;
            box-shadow: 0 0 0 3px rgba(121, 192, 255, 0.2);
        }

        button {
            background: #238636;
            color: white;
            border: 1px solid #2ea043;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 8px;
        }

        button:hover {
            background: #2ea043;
            box-shadow: 0 0 10px rgba(46, 160, 67, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        button.secondary {
            background: #1f6feb;
            border-color: #388bfd;
        }

        button.secondary:hover {
            background: #388bfd;
        }

        button.danger {
            background: #da3633;
            border-color: #f85149;
        }

        button.danger:hover {
            background: #f85149;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .button-group button {
            flex: 1;
            margin-bottom: 0;
            font-size: 0.85em;
            padding: 6px 10px;
        }

        .status-card {
            background: #0d1117;
            border-left: 3px solid #1f6feb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .status-label {
            color: #8b949e;
        }

        .status-value {
            color: #79c0ff;
            font-family: monospace;
            font-weight: 600;
        }

        .registers-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .registers-header {
            background: #0d1117;
            padding: 15px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .registers-header h2 {
            color: #79c0ff;
            font-size: 1.2em;
        }

        .registers-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th {
            background: #161b22;
            color: #79c0ff;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #30363d;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #30363d;
        }

        tr:hover {
            background: #0d1117;
        }

        .addr-cell {
            font-family: monospace;
            color: #79c0ff;
            font-weight: 600;
        }

        .name-cell {
            color: #a371f7;
            font-weight: 500;
        }

        .value-cell {
            font-family: monospace;
            text-align: right;
        }

        .bitfield-row {
            background: #0d1117;
        }

        .bitfield-content {
            padding: 15px 20px;
        }

        .bitfield-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #161b22;
            border-radius: 4px;
            align-items: center;
        }

        .bitfield-name {
            color: #79c0ff;
            font-weight: 600;
            font-family: monospace;
        }

        .bitfield-desc {
            color: #8b949e;
            font-size: 0.85em;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #30363d;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid #21262d;
        }

        .toggle-switch.active {
            background: #238636;
            border-color: #2ea043;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #e6edf3;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        .sensor-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .sensor-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .sensor-card h3 {
            color: #79c0ff;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .sensor-value {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #30363d;
        }

        .sensor-value:last-child {
            border-bottom: none;
        }

        .sensor-label {
            color: #8b949e;
        }

        .sensor-reading {
            color: #79c0ff;
            font-family: monospace;
            font-weight: 600;
        }

        .message {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #238636;
            border: 1px solid #2ea043;
            color: #e6edf3;
        }

        .message.error {
            background: #da3633;
            border: 1px solid #f85149;
            color: #e6edf3;
        }

        .message.info {
            background: #1f6feb;
            border: 1px solid #388bfd;
            color: #e6edf3;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #30363d;
            border-top-color: #79c0ff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preset-buttons button {
            flex: 1;
            min-width: 120px;
            font-size: 0.8em;
            padding: 6px 10px;
            margin-bottom: 0;
        }

        .info-text {
            color: #8b949e;
            font-size: 0.85em;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }

            .bitfield-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß MPU9250 Register Debugger</h1>
            <p class="header-info">Direct hardware register access and manipulation | WebSocket-based real-time updates</p>
        </header>

        <div id="message" class="message"></div>

        <div class="controls">
            <div class="control-panel">
                <h3>IMU Selection</h3>
                <div class="imu-selector">
                    <label for="imuSelect">Select IMU:</label>
                    <select id="imuSelect">
                        <option value="left">Left IMU</option>
                        <option value="right">Right IMU</option>
                    </select>
                </div>
                <button class="secondary" onclick="readAllRegisters()">üìñ Read All Registers</button>
                <button onclick="reinitializeIMU()">üîÑ Reinitialize IMU</button>
                <div class="status-card">
                    <div class="status-item">
                        <span class="status-label">Connection:</span>
                        <span class="status-value" id="connStatus">‚è≥ Connecting...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Selected:</span>
                        <span class="status-value" id="selectedIMU">left</span>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <h3>SPI Speed Control</h3>
                <label>Read Speed (Hz):</label>
                <input type="number" id="readSpeed" value="1000000" placeholder="1000000">
                <label>Write Speed (Hz):</label>
                <input type="number" id="writeSpeed" value="500000" placeholder="500000">
                <button onclick="setSPISpeed()" class="secondary">‚ö° Apply SPI Speed</button>
                <div class="preset-buttons">
                    <button onclick="setPresetSPISpeed('fast')" style="background: #1f6feb;">Fast</button>
                    <button onclick="setPresetSPISpeed('normal')" style="background: #1f6feb;">Normal</button>
                    <button onclick="setPresetSPISpeed('slow')" style="background: #1f6feb;">Slow</button>
                </div>
                <p class="info-text">Presets: Fast=4MHz/1MHz, Normal=1MHz/500kHz, Slow=500kHz/250kHz</p>
            </div>

            <div class="control-panel">
                <h3>Single Register Access</h3>
                <label>Register Address (hex):</label>
                <input type="text" id="regAddr" placeholder="0x1B" value="0x1B">
                <button onclick="readRegister()" class="secondary">üìñ Read Register</button>
                <label style="margin-top: 15px;">New Value (hex):</label>
                <input type="text" id="regValue" placeholder="0x00" value="0x00">
                <button onclick="writeRegister()" class="danger">‚úçÔ∏è Write Register</button>
                <p class="info-text">Warning: Incorrect values may lock the IMU!</p>
            </div>
        </div>

        <div class="sensor-data" id="sensorData" style="display: none; margin-bottom: 30px;">
            <div class="sensor-card">
                <h3>üìä Accelerometer</h3>
                <div class="sensor-value">
                    <span class="sensor-label">X-Axis:</span>
                    <span class="sensor-reading" id="accelX">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Y-Axis:</span>
                    <span class="sensor-reading" id="accelY">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Z-Axis:</span>
                    <span class="sensor-reading" id="accelZ">0</span>
                </div>
            </div>

            <div class="sensor-card">
                <h3>üîÑ Gyroscope</h3>
                <div class="sensor-value">
                    <span class="sensor-label">X-Axis:</span>
                    <span class="sensor-reading" id="gyroX">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Y-Axis:</span>
                    <span class="sensor-reading" id="gyroY">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Z-Axis:</span>
                    <span class="sensor-reading" id="gyroZ">0</span>
                </div>
            </div>

            <div class="sensor-card">
                <h3>üß≤ Magnetometer</h3>
                <div class="sensor-value">
                    <span class="sensor-label">X-Axis:</span>
                    <span class="sensor-reading" id="magX">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Y-Axis:</span>
                    <span class="sensor-reading" id="magY">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Z-Axis:</span>
                    <span class="sensor-reading" id="magZ">0</span>
                </div>
                <div class="sensor-value">
                    <span class="sensor-label">Magnitude:</span>
                    <span class="sensor-reading" id="magMag">0</span>
                </div>
            </div>
        </div>

        <div class="registers-container">
            <div class="registers-header">
                <h2>MPU9250 Registers (0x00-0x7F)</h2>
                <button id="exportBtn" onclick="exportRegisters()" class="secondary" style="width: 180px;">üì• Export Config</button>
            </div>
            <div class="registers-table">
                <table id="registersTable">
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Value (Hex)</th>
                            <th>Value (Bin)</th>
                            <th>Value (Dec)</th>
                        </tr>
                    </thead>
                    <tbody id="registersBody">
                        <tr><td colspan="6" style="text-align: center; color: #8b949e;">Loading registers...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let messageTimeout;

        function showMessage(text, type = 'info') {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.className = `message show ${type}`;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                msgEl.classList.remove('show');
            }, 5000);
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                showMessage('‚úÖ Connected to register debugger', 'success');
                document.getElementById('connStatus').textContent = 'üü¢ Connected';
                readAllRegisters();
                startSensorPolling();
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Failed to parse WebSocket message:', e);
                }
            };

            ws.onerror = (error) => {
                showMessage('‚ùå WebSocket error', 'error');
                document.getElementById('connStatus').textContent = 'üî¥ Error';
            };

            ws.onclose = () => {
                document.getElementById('connStatus').textContent = 'üü° Disconnected';
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'register_data') {
                if (data.registers) {
                    displayRegisters(data.registers);
                }
            } else if (data.type === 'status') {
                updateStatus(data);
            } else if (data.type === 'error') {
                showMessage(`‚ùå Error: ${data.message}`, 'error');
            }
        }

        function updateStatus(status) {
            const spiInfo = document.querySelector('.status-card');
            if (!spiInfo.innerHTML.includes('SPI Speed')) {
                const html = `
                    <div class="status-item">
                        <span class="status-label">Connection:</span>
                        <span class="status-value" id="connStatus">üü¢ Connected</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">IMU Status:</span>
                        <span class="status-value">${status.status}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Read Speed:</span>
                        <span class="status-value">${formatHz(status.read_speed)}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Write Speed:</span>
                        <span class="status-value">${formatHz(status.write_speed)}</span>
                    </div>
                `;
                spiInfo.innerHTML = html;
            }
        }

        function formatHz(hz) {
            if (hz >= 1000000) return (hz / 1000000).toFixed(1) + ' MHz';
            if (hz >= 1000) return (hz / 1000).toFixed(1) + ' kHz';
            return hz + ' Hz';
        }

        function displayRegisters(registers) {
            const tbody = document.getElementById('registersBody');
            if (!registers || Object.keys(registers).length === 0) return;

            tbody.innerHTML = '';
            Object.entries(registers).forEach(([addr, value]) => {
                const row = document.createElement('tr');
                const addrNum = parseInt(addr, 16);
                const hexAddr = '0x' + addrNum.toString(16).toUpperCase().padStart(2, '0');
                const binValue = value.toString(2).padStart(8, '0');
                const decValue = value;

                row.innerHTML = `
                    <td class="addr-cell">${hexAddr}</td>
                    <td class="name-cell">REG_${addrNum.toString(16).toUpperCase().padStart(2, '0')}</td>
                    <td>Register at offset ${hexAddr}</td>
                    <td class="value-cell" style="font-family: monospace;">0x${value.toString(16).toUpperCase().padStart(2, '0')}</td>
                    <td class="value-cell" style="font-family: monospace; font-size: 0.85em;">${binValue}</td>
                    <td class="value-cell" style="font-family: monospace;">${decValue}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function readAllRegisters() {
            const imu = document.getElementById('imuSelect').value;
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'read_all', imu: imu}));
            }
        }

        function readRegister() {
            const imu = document.getElementById('imuSelect').value;
            const addr = document.getElementById('regAddr').value;
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'read', imu: imu, addr: addr}));
            }
        }

        function writeRegister() {
            const imu = document.getElementById('imuSelect').value;
            const addr = document.getElementById('regAddr').value;
            const value = document.getElementById('regValue').value;
            if (confirm(`‚ö†Ô∏è Write 0x${value} to register 0x${addr} on ${imu} IMU?\n\nThis may affect sensor operation!`)) {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({action: 'write', imu: imu, addr: addr, value: value}));
                }
            }
        }

        function setSPISpeed() {
            const imu = document.getElementById('imuSelect').value;
            const readSpeed = parseInt(document.getElementById('readSpeed').value);
            const writeSpeed = parseInt(document.getElementById('writeSpeed').value);
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'set_spi_speed', imu: imu, read_speed: readSpeed, write_speed: writeSpeed}));
                showMessage(`‚ö° SPI speed updated: Read=${formatHz(readSpeed)}, Write=${formatHz(writeSpeed)}`, 'success');
            }
        }

        function setPresetSPISpeed(preset) {
            const presets = {
                'fast': {read: 4000000, write: 1000000},
                'normal': {read: 1000000, write: 500000},
                'slow': {read: 500000, write: 250000}
            };
            const p = presets[preset];
            document.getElementById('readSpeed').value = p.read;
            document.getElementById('writeSpeed').value = p.write;
            setSPISpeed();
        }

        function reinitializeIMU() {
            const imu = document.getElementById('imuSelect').value;
            if (confirm(`üîÑ Reinitialize ${imu} IMU?\n\nThis will reset the hardware connection.`)) {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({action: 'init', imu: imu}));
                    showMessage(`üîÑ Reinitialized ${imu} IMU`, 'success');
                }
            }
        }

        function exportRegisters() {
            const imu = document.getElementById('imuSelect').value;
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'export_config', imu: imu}));
                showMessage('üì• Configuration exported', 'success');
            }
        }

        function startSensorPolling() {
            setInterval(() => {
                const imu = document.getElementById('imuSelect').value;
                fetch(`/api/imu?imu=${imu}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data && data.accel) {
                            document.getElementById('sensorData').style.display = 'grid';
                            document.getElementById('accelX').textContent = data.accel.x;
                            document.getElementById('accelY').textContent = data.accel.y;
                            document.getElementById('accelZ').textContent = data.accel.z;
                            document.getElementById('gyroX').textContent = data.gyro.x;
                            document.getElementById('gyroY').textContent = data.gyro.y;
                            document.getElementById('gyroZ').textContent = data.gyro.z;
                            document.getElementById('magX').textContent = data.mag.x;
                            document.getElementById('magY').textContent = data.mag.y;
                            document.getElementById('magZ').textContent = data.mag.z;
                            document.getElementById('magMag').textContent = data.mag.magnitude || 'N/A';
                        }
                    })
                    .catch(e => console.error('Sensor polling error:', e));
            }, 100);
        }

        document.getElementById('imuSelect').addEventListener('change', (e) => {
            document.getElementById('selectedIMU').textContent = e.target.value;
            readAllRegisters();
        });

        connectWebSocket();
    </script>
</body>
</html>
