<!DOCTYPE html>
<!--
  Copyright (c) 2026 Daniel Alarcon Rubio / Relabs Tech
  SPDX-License-Identifier: MIT
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MPU9250 Register Debugger</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0d0f14;
      --bg-card: #1a1d24;
      --text: #e0e0e0;
      --muted: #888888;
      --accent: #4fc3f7;
      --success: #4caf50;
      --error: #f44336;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    body {
      background: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid var(--accent);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }

    .subtitle {
      color: var(--muted);
      font-size: 1rem;
    }

    .status {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }

    .status.connected {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
      border: 2px solid var(--success);
    }

    .status.disconnected {
      background: rgba(244, 67, 54, 0.2);
      color: var(--error);
      border: 2px solid var(--error);
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .control-group {
      background: var(--bg-card);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .control-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .control-group select,
    .control-group input {
      width: 100%;
      padding: 0.6rem;
      background: #0a0b0f;
      border: 1px solid #444;
      border-radius: 4px;
      color: var(--text);
      font-size: 0.9rem;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
    }

    button {
      padding: 0.8rem 1.5rem;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 4px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #81d4fa;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(79, 195, 247, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .action-buttons button {
      flex: 1;
      min-width: 120px;
    }

    /* Live Sensor Data Card */
    .live-sensor-card {
      max-width: 1200px;
      margin: 0 auto 2rem;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #333;
    }

    .live-sensor-card h2 {
      margin: 0 0 1rem;
      font-size: 1.3rem;
      color: var(--accent);
      text-align: center;
    }

    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1rem;
    }

    .sensor-section {
      background: #0a0b0f;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #333;
    }

    .sensor-section h3 {
      margin: 0 0 0.75rem;
      font-size: 1rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sensor-axes {
      display: grid;
      gap: 0.5rem;
    }

    .sensor-axis {
      display: grid;
      grid-template-columns: 20px 1fr auto;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: rgba(79, 195, 247, 0.05);
      border-radius: 4px;
    }

    .axis-label {
      font-weight: 600;
      color: var(--accent);
      font-family: 'Courier New', monospace;
    }

    .axis-value {
      text-align: right;
      font-family: 'Courier New', monospace;
      color: var(--text);
    }

    /* Register Table */
    .table-container {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #333;
      margin-bottom: 2rem;
      overflow-x: auto;
    }

    .table-container h2 {
      margin-bottom: 1rem;
      color: var(--accent);
      font-size: 1.3rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: #0a0b0f;
      border-bottom: 2px solid var(--accent);
    }

    th {
      padding: 0.75rem;
      text-align: left;
      color: var(--accent);
      font-weight: 600;
    }

    tbody tr {
      border-bottom: 1px solid #333;
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(79, 195, 247, 0.05);
    }

    td {
      padding: 0.75rem;
      vertical-align: top;
    }

    .reg-addr {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: var(--accent);
    }

    .reg-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.3rem;
    }

    .reg-desc {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .reg-value {
      font-family: 'Courier New', monospace;
      background: #0a0b0f;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      text-align: center;
      color: var(--accent);
      font-weight: 600;
    }

    .reg-access {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
    }

    .reg-access.read-only {
      background: rgba(244, 67, 54, 0.2);
      color: var(--error);
    }

    .reg-access.writable {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }

    /* Bit Fields Display */
    .bit-fields {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: rgba(79, 195, 247, 0.05);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
    }

    .bit-fields-title {
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .bit-field-item {
      margin: 0.4rem 0;
      padding: 0.3rem 0;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .bit-field-item:last-child {
      border-bottom: none;
    }

    .bit-field-bits {
      font-family: 'Courier New', monospace;
      color: var(--accent);
      font-weight: 600;
      margin-right: 0.5rem;
    }

    .bit-field-name {
      font-weight: 500;
      color: var(--text);
      margin-right: 0.5rem;
    }

    .bit-field-desc {
      color: var(--muted);
      font-size: 0.75rem;
      display: block;
      margin-top: 0.2rem;
      margin-left: 4rem;
    }

    .bit-field-values {
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 4rem;
      margin-top: 0.2rem;
    }

    /* Bit toggle controls */
    .bit-toggles {
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }

    .bit-toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .bit-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      padding: 0.2rem 0.35rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 4px;
      background: rgba(79, 195, 247, 0.05);
    }

    .bit-toggle input {
      accent-color: var(--accent);
    }

    .bit-toggle-label {
      color: var(--text);
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
      }

      .sensor-grid {
        grid-template-columns: 1fr;
      }

      .table-container {
        padding: 1rem;
      }

      table {
        font-size: 0.8rem;
      }

      td {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>MPU9250 Register Debugger</h1>
      <p class="subtitle">Low-level hardware register inspection and configuration</p>
    </div>

    <div id="status" class="status disconnected">Disconnected</div>

    <!-- Connection Diagnostics -->
    <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: none;" id="diagnostic-panel">
      <h3 style="color: var(--error); margin-bottom: 0.5rem;">‚ö†Ô∏è Connection Diagnostics</h3>
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <strong>Issue:</strong> WebSocket connection failed to <code style="background: #0a0b0f; padding: 0.2rem 0.4rem; border-radius: 3px; color: var(--accent);">ws://100.71.254.68:8081/ws</code>
      </p>
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <strong>Reason:</strong> The register debug server is not running or not reachable on port 8081
      </p>
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <strong>Fix:</strong> Start the register debug server:
      </p>
      <code style="display: block; background: #0a0b0f; padding: 0.8rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; font-size: 0.85rem;">
cd /home/dalarub/go/src/github.com/relabs-tech/inertial_computer<br/>sudo ./register_debug
      </code>
      <p style="margin: 0.3rem 0; font-size: 0.85rem; color: var(--muted);">
        Then access in browser: <code style="background: #0a0b0f; padding: 0.2rem 0.4rem; border-radius: 3px; color: var(--accent);">http://100.71.254.68:8081</code>
      </p>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="control-group">
        <label for="device-select">Select Device:</label>
        <select id="device-select" onchange="deviceChanged()">
          <option value="left">Left IMU</option>
          <option value="right">Right IMU</option>
        </select>
      </div>

      <div class="control-group">
        <label for="averaging-select">Averaging:</label>
        <select id="averaging-select">
          <option value="1">No Averaging (1)</option>
          <option value="5">5 Samples</option>
          <option value="10">10 Samples</option>
          <option value="20">20 Samples</option>
        </select>
      </div>

      <div class="control-group action-buttons">
        <button onclick="readAllRegisters()">üìñ Read All Registers</button>
        <button onclick="reinitializeIMU()">üîÑ Reinitialize IMU</button>
      </div>
    </div>

    <!-- Live Sensor Data -->
    <div class="live-sensor-card">
      <h2>üî¥ Live Sensor Data</h2>
      <div class="sensor-grid">
        <div class="sensor-section">
          <h3>üìä Accelerometer</h3>
          <div class="sensor-axes">
            <div class="sensor-axis">
              <span class="axis-label">X</span>
              <div>Raw ADC counts (¬±8g)</div>
              <span class="axis-value" id="accel-x">---</span>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Y</span>
              <div>Raw ADC counts (¬±8g)</div>
              <span class="axis-value" id="accel-y">---</span>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Z</span>
              <div>Raw ADC counts (¬±8g)</div>
              <span class="axis-value" id="accel-z">---</span>
            </div>
            <div style="grid-column: 1 / -1; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; color: var(--muted);">
              <strong>Range:</strong> <span id="accel-range">¬±8g</span>
            </div>
          </div>
        </div>

        <div class="sensor-section">
          <h3>üîÑ Gyroscope</h3>
          <div class="sensor-axes">
            <div class="sensor-axis">
              <span class="axis-label">X</span>
              <div>Raw ADC counts (¬±500¬∞/s)</div>
              <span class="axis-value" id="gyro-x">---</span>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Y</span>
              <div>Raw ADC counts (¬±500¬∞/s)</div>
              <span class="axis-value" id="gyro-y">---</span>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Z</span>
              <div>Raw ADC counts (¬±500¬∞/s)</div>
              <span class="axis-value" id="gyro-z">---</span>
            </div>
            <div style="grid-column: 1 / -1; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; color: var(--muted);">
              <strong>Range:</strong> <span id="gyro-range">¬±500¬∞/s</span>
            </div>
          </div>
        </div>

        <div class="sensor-section">
          <h3>üß≠ Magnetometer</h3>
          <div class="sensor-axes">
            <div class="sensor-axis">
              <span class="axis-label">X</span>
              <div>¬µT √ó 10</div>
              <span class="axis-value" id="mag-x">---</span>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Y</span>
              <div>¬µT √ó 10</div>
              <span class="axis-value" id="mag-y">---</span>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Z</span>
              <div>¬µT √ó 10</div>
              <span class="axis-value" id="mag-z">---</span>
            </div>
            <div style="grid-column: 1 / -1; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; color: var(--muted);">
              <strong>|B|:</strong> <span id="mag-magnitude">---</span> ¬µT
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Register Table -->
    <div class="table-container">
      <h2>üìã MPU9250 Registers (0x00-0x7F)</h2>
      <table>
        <thead>
          <tr>
            <th>Address</th>
            <th>Register</th>
            <th>Description</th>
            <th>Value (hex)</th>
            <th>Access</th>
          </tr>
        </thead>
        <tbody id="register-table">
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem;">
              <span style="color: var(--muted);">Click "Read All Registers" to populate table</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let ws = null;
    let currentDevice = 'left';
    let registerMap = [];
    let registerValues = {};
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    let liveDataTimer = null;
    const LIVE_POLL_MS = 500;

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      
      // Backend serves WebSocket at /ws on port 8081
      let host = window.location.host;
      if (window.location.port && window.location.port !== '8081') {
        // If we're not on port 8081, connect to 8081
        const hostname = window.location.hostname;
        host = `${hostname}:8081`;
      }
      
      const url = `${protocol}//${host}/ws`;
      
      console.log(`Attempting WebSocket connection to: ${url}`);
      updateStatus(`Connecting to ${host}...`, false);
      
      ws = new WebSocket(url);
      
      ws.onopen = () => {
        updateStatus('Connected', true);
        console.log('WebSocket connected successfully');
        reconnectAttempts = 0;
        // Request register map explicitly in case the initial push was missed
        sendWebSocketMessage({ action: 'get_map', device: 'mpu9250' });
        // Populate values on connect
        readAllRegisters();
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleWebSocketMessage(msg);
        } catch (err) {
          console.error('WebSocket message parse error:', err);
        }
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        updateStatus('Connection Failed - Backend Not Running', false);
      };

      ws.onclose = () => {
        updateStatus('Disconnected', false);
        console.log('WebSocket disconnected');
        
        reconnectAttempts++;
        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
          console.log(`Reconnection attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} in ${delay}ms`);
          setTimeout(connectWebSocket, delay);
        } else {
          updateStatus('Connection Failed - Check if register_debug server is running on port 8081', false);
        }
      };
    }

    function handleWebSocketMessage(msg) {
      if (msg.type === 'register_data') {
        if (msg.registers) {
          // Bulk read response
          registerValues = normalizeRegisterValues(msg.registers);
          renderRegisterTable();
        } else if (msg.addr && msg.value !== undefined) {
          // Single register update
          registerValues[msg.addr] = parseInt(msg.value, 16);
          updateRegisterRow(msg.addr, msg.value);
        }
      } else if (msg.type === 'register_map') {
        registerMap = msg.register_map || [];
        renderRegisterTable();
      } else if (msg.type === 'sensor_data') {
        updateLiveSensorData(msg);
      } else if (msg.type === 'status') {
        console.log('Status:', msg);
      } else if (msg.type === 'error') {
        console.error('Server error:', msg.message);
      }
    }

    function updateStatus(text, isConnected) {
      const statusEl = document.getElementById('status');
      const diagPanel = document.getElementById('diagnostic-panel');
      statusEl.textContent = text;
      statusEl.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
      
      // Show diagnostic panel if connection failed
      if (!isConnected && text.includes('Failed')) {
        diagPanel.style.display = 'block';
      } else {
        diagPanel.style.display = 'none';
      }
    }

    function updateLiveSensorData(msg) {
      const accel = msg.accel || { x: msg.ax, y: msg.ay, z: msg.az };
      const gyro = msg.gyro || { x: msg.gx, y: msg.gy, z: msg.gz };
      const mag = msg.mag || { x: msg.mx, y: msg.my, z: msg.mz };

      document.getElementById('accel-x').textContent = formatAxis(accel.x);
      document.getElementById('accel-y').textContent = formatAxis(accel.y);
      document.getElementById('accel-z').textContent = formatAxis(accel.z);

      document.getElementById('gyro-x').textContent = formatAxis(gyro.x);
      document.getElementById('gyro-y').textContent = formatAxis(gyro.y);
      document.getElementById('gyro-z').textContent = formatAxis(gyro.z);

      document.getElementById('mag-x').textContent = formatAxis(mag.x);
      document.getElementById('mag-y').textContent = formatAxis(mag.y);
      document.getElementById('mag-z').textContent = formatAxis(mag.z);

      const magMagnitude = computeMagnitude(mag.x, mag.y, mag.z);
      document.getElementById('mag-magnitude').textContent = magMagnitude ?? '---';
    }

    function formatAxis(value) {
      return value === undefined || value === null ? '---' : value;
    }

    function computeMagnitude(x, y, z) {
      if ([x, y, z].some((v) => v === undefined || v === null)) {
        return null;
      }
      const fx = Number(x);
      const fy = Number(y);
      const fz = Number(z);
      if ([fx, fy, fz].some((v) => Number.isNaN(v))) {
        return null;
      }
      return Math.sqrt(fx * fx + fy * fy + fz * fz).toFixed(1);
    }

    function sendWebSocketMessage(msg) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('WebSocket not connected');
        return;
      }
      msg.imu = currentDevice;  // Backend expects 'imu' field, not 'device'
      ws.send(JSON.stringify(msg));
    }

    function readAllRegisters() {
      sendWebSocketMessage({ action: 'read_all' });
    }

    function reinitializeIMU() {
      if (confirm('Reinitialize ' + currentDevice + ' IMU?')) {
        sendWebSocketMessage({ action: 'init' });
      }
    }

    function deviceChanged() {
      currentDevice = document.getElementById('device-select').value;
      registerValues = {};
      document.getElementById('register-table').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;"><span style="color: var(--muted);">Click "Read All Registers" to populate table</span></td></tr>';
      startLiveDataPolling();
    }

    function renderRegisterTable() {
      const tbody = document.getElementById('register-table');
      tbody.innerHTML = '';

      if (!registerMap || registerMap.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;"><span style="color: var(--muted);">No register map available</span></td></tr>';
        return;
      }

      registerMap.forEach((reg) => {
        const addr = typeof reg.address === 'string' ? reg.address : '0x' + reg.address.toString(16).toUpperCase().padStart(2, '0');
        const value = registerValues[addr] ?? registerValues[parseInt(addr, 16)] ?? 0;
        const hexValue = '0x' + (value & 0xFF).toString(16).toUpperCase().padStart(2, '0');
        const writable = reg.access && reg.access.includes('W');

        const tr = document.createElement('tr');

        let bitFieldsHTML = '';
        if (reg.bit_fields && reg.bit_fields.length > 0) {
          bitFieldsHTML = '<div class="bit-fields">';
          bitFieldsHTML += '<div class="bit-fields-title">Bit Fields:</div>';
          reg.bit_fields.forEach(bf => {
            bitFieldsHTML += '<div class="bit-field-item">';
            bitFieldsHTML += `<span class="bit-field-bits">${bf.bits}</span>`;
            bitFieldsHTML += `<span class="bit-field-name">${bf.name}</span>`;
            if (bf.description) {
              bitFieldsHTML += `<div class="bit-field-desc">${bf.description}</div>`;
            }
            bitFieldsHTML += '</div>';
          });
          bitFieldsHTML += '</div>';
        }

        tr.innerHTML = `
          <td class="reg-addr">${addr}</td>
          <td>
            <div class="reg-name">${reg.name}</div>
            ${bitFieldsHTML}
          </td>
          <td class="reg-desc">${reg.description}</td>
          <td class="reg-value">${hexValue}</td>
          <td>
            <span class="reg-access ${writable ? 'writable' : 'read-only'}">
              ${reg.access}
            </span>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function normalizeRegisterValues(rawMap) {
      const normalized = {};
      Object.entries(rawMap || {}).forEach(([addr, value]) => {
        const addrKey = addr.startsWith('0x') ? addr.toUpperCase() : '0x' + Number(addr).toString(16).toUpperCase().padStart(2, '0');
        const parsedValue = typeof value === 'string' ? parseInt(value, 16) : Number(value) || 0;
        normalized[addrKey] = parsedValue;
        normalized[parseInt(addrKey, 16)] = parsedValue;
      });
      return normalized;
    }

    function fetchLiveData() {
      fetch(`/api/imu?imu=${currentDevice}`)
        .then((resp) => {
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }
          return resp.json();
        })
        .then((data) => updateLiveSensorData(data))
        .catch((err) => console.warn('Live data fetch failed:', err));
    }

    function startLiveDataPolling() {
      if (liveDataTimer) {
        clearInterval(liveDataTimer);
      }
      fetchLiveData();
      liveDataTimer = setInterval(fetchLiveData, LIVE_POLL_MS);
    }

    // Initialize WebSocket connection on page load
    window.addEventListener('load', () => {
      connectWebSocket();
      startLiveDataPolling();
    });
  </script>
</body>
</html>
