<!DOCTYPE html>
<!--
  Copyright (c) 2026 Daniel Alarcon Rubio / Relabs Tech
  SPDX-License-Identifier: MIT
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MPU9250 Register Debugger</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0d0f14;
      --bg-card: #1a1d24;
      --text: #e0e0e0;
      --muted: #888888;
      --accent: #4fc3f7;
      --success: #4caf50;
      --error: #f44336;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    body {
      background: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid var(--accent);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }

    .subtitle {
      color: var(--muted);
      font-size: 1rem;
    }

    .status {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }

    .status.connected {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
      border: 2px solid var(--success);
    }

    .status.disconnected {
      background: rgba(244, 67, 54, 0.2);
      color: var(--error);
      border: 2px solid var(--error);
    }

    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: stretch;
      margin-bottom: 2rem;
    }

    .control-rail {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
      align-items: stretch;
    }

    .control-group {
      background: var(--bg-card);
      padding: 0.9rem;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .control-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .control-group select,
    .control-group input {
      width: 100%;
      padding: 0.6rem;
      background: #0a0b0f;
      border: 1px solid #444;
      border-radius: 4px;
      color: var(--text);
      font-size: 0.9rem;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
    }

    button {
      padding: 0.8rem 1.5rem;
      background: var(--accent);
      color: #000;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #81d4fa;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(79, 195, 247, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .action-buttons button {
      flex: 1;
      min-width: 120px;
    }

    .action-buttons button.active {
      background: #81d4fa;
      color: #000;
      box-shadow: 0 4px 8px rgba(79, 195, 247, 0.5);
      border-color: var(--accent);
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Live Sensor Data Card */
    .live-sensor-card {
      max-width: 1200px;
      margin: 0;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #333;
    }

    .live-sensor-card h2 {
      margin: 0 0 1rem;
      font-size: 1.3rem;
      color: var(--accent);
      text-align: center;
    }

    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
      gap: 1rem;
    }

    .sensor-section {
      background: #0a0b0f;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #333;
    }

    .sensor-section h3 {
      margin: 0 0 0.75rem;
      font-size: 1rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sensor-axes {
      display: grid;
      gap: 0.5rem;
    }

    .sensor-axis {
      display: grid;
      grid-template-columns: 20px 1fr auto;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: rgba(79, 195, 247, 0.05);
      border-radius: 4px;
    }

    .axis-label {
      font-weight: 600;
      color: var(--accent);
      font-family: 'Courier New', monospace;
    }

    .axis-value {
      text-align: right;
      font-family: 'Courier New', monospace;
      color: var(--text);
    }

    .axis-subvalue {
      grid-column: 2 / 4;
      font-size: 0.85rem;
      color: var(--muted);
      font-family: 'Courier New', monospace;
    }

    /* Register Table */
    .table-container {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #333;
      margin: 0 0 2rem;
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
    }

    .table-container h2 {
      margin-bottom: 1rem;
      color: var(--accent);
      font-size: 1.3rem;
    }

    /* Quick configs row under live data */
    .quick-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
      background: var(--bg-card);
      border: 1px solid #333;
      border-radius: 12px;
      padding: 1rem;
      margin: 0 0 1.5rem;
    }

    .quick-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .quick-label {
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: #0a0b0f;
      border-bottom: 2px solid var(--accent);
    }

    th {
      padding: 0.75rem;
      text-align: left;
      color: var(--accent);
      font-weight: 600;
    }

    tbody tr {
      border-bottom: 1px solid #333;
      transition: background 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(79, 195, 247, 0.05);
    }

    td {
      padding: 0.75rem;
      vertical-align: top;
    }

    .reg-addr {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: var(--accent);
    }

    .reg-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.3rem;
    }

    .reg-desc {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .reg-value {
      font-family: 'Courier New', monospace;
      background: #0a0b0f;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      text-align: center;
      color: var(--accent);
      font-weight: 600;
    }

    .reg-access {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
    }

    .reg-access.read-only {
      background: rgba(244, 67, 54, 0.2);
      color: var(--error);
    }

    .reg-access.writable {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }

    /* Bit Fields Display */
    .bit-fields {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: rgba(79, 195, 247, 0.05);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
    }

    .bit-fields-title {
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .bit-field-item {
      margin: 0.4rem 0;
      padding: 0.3rem 0;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .bit-field-item:last-child {
      border-bottom: none;
    }

    .bit-field-bits {
      font-family: 'Courier New', monospace;
      color: var(--accent);
      font-weight: 600;
      margin-right: 0.5rem;
    }

    .bit-field-name {
      font-weight: 500;
      color: var(--text);
      margin-right: 0.5rem;
    }

    .bit-field-desc {
      color: var(--muted);
      font-size: 0.75rem;
      display: block;
      margin-top: 0.2rem;
      margin-left: 4rem;
    }

    .bit-field-values {
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 4rem;
      margin-top: 0.2rem;
    }

    /* Bit toggle controls */
    .bit-toggles {
      margin-top: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
    }

    .bit-toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .bit-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      padding: 0.2rem 0.35rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 4px;
      background: rgba(79, 195, 247, 0.05);
    }

    .bit-toggle input {
      accent-color: var(--accent);
    }

    .bit-toggle-label {
      color: var(--text);
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    @media (max-width: 768px) {
      .sensor-grid {
        grid-template-columns: 1fr;
      }

      .table-container {
        padding: 1rem;
        margin: 0;
        width: 100%;
        max-width: 100%;
      }

      table {
        font-size: 0.8rem;
      }

      td {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <h1>MPU9250 Register Debugger</h1>
      <p class="subtitle">Low-level hardware register inspection and configuration</p>
    </div>

    <div id="status" class="status disconnected">Disconnected</div>

    <!-- Connection Diagnostics -->
    <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; display: none;" id="diagnostic-panel">
      <h3 style="color: var(--error); margin-bottom: 0.5rem;">‚ö†Ô∏è Connection Diagnostics</h3>
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <strong>Issue:</strong> WebSocket connection failed to <code style="background: #0a0b0f; padding: 0.2rem 0.4rem; border-radius: 3px; color: var(--accent);">ws://100.71.254.68:8081/ws</code>
      </p>
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <strong>Reason:</strong> The register debug server is not running or not reachable on port 8081
      </p>
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <strong>Fix:</strong> Start the register debug server:
      </p>
      <code style="display: block; background: #0a0b0f; padding: 0.8rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto; font-size: 0.85rem;">
cd /home/dalarub/go/src/github.com/relabs-tech/inertial_computer<br/>sudo ./register_debug
      </code>
      <p style="margin: 0.3rem 0; font-size: 0.85rem; color: var(--muted);">
        Then access in browser: <code style="background: #0a0b0f; padding: 0.2rem 0.4rem; border-radius: 3px; color: var(--accent);">http://100.71.254.68:8081</code>
      </p>
    </div>

    <div class="main-panel">
      <div class="control-rail">
        <div class="control-group">
          <label for="device-select">Select Device:</label>
          <select id="device-select" onchange="deviceChanged()">
            <option value="left">Left IMU</option>
            <option value="right">Right IMU</option>
          </select>
        </div>

        <div class="control-group">
          <label for="register-device-select">Register Map:</label>
          <select id="register-device-select" onchange="registerDeviceChanged()">
            <option value="mpu9250">MPU9250</option>
            <option value="ak8963">AK8963 (Mag)</option>
          </select>
        </div>

        <div class="control-group">
          <label for="averaging-select">Averaging:</label>
          <select id="averaging-select">
            <option value="1">No Averaging (1)</option>
            <option value="5">5 Samples</option>
            <option value="10">10 Samples</option>
            <option value="20">20 Samples</option>
          </select>
        </div>

        <div class="control-group action-buttons">
          <button onclick="readAllRegisters()">üìñ Read All Registers</button>
          <button onclick="reinitializeIMU()">üîÑ Reinitialize IMU</button>
        </div>
      </div>

      <!-- Live Sensor Data -->
      <div class="live-sensor-card">
      <h2>üî¥ Live Sensor Data</h2>
      <div class="sensor-grid">
        <div class="sensor-section">
          <h3>üìä Accelerometer</h3>
          <div class="sensor-axes">
            <div class="sensor-axis">
              <span class="axis-label">X</span>
              <div>Raw ADC counts</div>
              <span class="axis-value" id="accel-x">---</span>
              <div class="axis-subvalue">‚á¢ <span id="accel-x-g">---</span> g</div>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Y</span>
              <div>Raw ADC counts</div>
              <span class="axis-value" id="accel-y">---</span>
              <div class="axis-subvalue">‚á¢ <span id="accel-y-g">---</span> g</div>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Z</span>
              <div>Raw ADC counts</div>
              <span class="axis-value" id="accel-z">---</span>
              <div class="axis-subvalue">‚á¢ <span id="accel-z-g">---</span> g</div>
            </div>
            <div style="grid-column: 1 / -1; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; color: var(--muted);">
              <strong>Range:</strong> <span id="accel-range">¬±8g</span>
            </div>
          </div>
        </div>

        <div class="sensor-section">
          <h3>üîÑ Gyroscope</h3>
          <div class="sensor-axes">
            <div class="sensor-axis">
              <span class="axis-label">X</span>
              <div>Raw ADC counts</div>
              <span class="axis-value" id="gyro-x">---</span>
              <div class="axis-subvalue">‚á¢ <span id="gyro-x-dps">---</span> ¬∞/s</div>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Y</span>
              <div>Raw ADC counts</div>
              <span class="axis-value" id="gyro-y">---</span>
              <div class="axis-subvalue">‚á¢ <span id="gyro-y-dps">---</span> ¬∞/s</div>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Z</span>
              <div>Raw ADC counts</div>
              <span class="axis-value" id="gyro-z">---</span>
              <div class="axis-subvalue">‚á¢ <span id="gyro-z-dps">---</span> ¬∞/s</div>
            </div>
            <div style="grid-column: 1 / -1; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; color: var(--muted);">
              <strong>Range:</strong> <span id="gyro-range">¬±500¬∞/s</span>
            </div>
          </div>
        </div>

        <div class="sensor-section">
          <h3>üß≠ Magnetometer</h3>
          <div class="sensor-axes">
            <div class="sensor-axis">
              <span class="axis-label">X</span>
              <div>¬µT √ó 10</div>
              <span class="axis-value" id="mag-x">---</span>
              <div class="axis-subvalue">‚á¢ <span id="mag-x-ut">---</span> ¬µT</div>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Y</span>
              <div>¬µT √ó 10</div>
              <span class="axis-value" id="mag-y">---</span>
              <div class="axis-subvalue">‚á¢ <span id="mag-y-ut">---</span> ¬µT</div>
            </div>
            <div class="sensor-axis">
              <span class="axis-label">Z</span>
              <div>¬µT √ó 10</div>
              <span class="axis-value" id="mag-z">---</span>
              <div class="axis-subvalue">‚á¢ <span id="mag-z-ut">---</span> ¬µT</div>
            </div>
            <div style="grid-column: 1 / -1; padding: 0.5rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; color: var(--muted);">
              <strong>|B|:</strong> <span id="mag-magnitude">---</span> ¬µT
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Configs under live data to shorten side stack -->
      <div class="quick-controls">
        <div class="quick-group">
          <label class="quick-label">Accelerometer Range</label>
          <div class="action-buttons">
            <button data-accel="2" onclick="setAccelRange(2)">¬±2g</button>
            <button data-accel="4" onclick="setAccelRange(4)">¬±4g</button>
            <button data-accel="8" onclick="setAccelRange(8)">¬±8g</button>
            <button data-accel="16" onclick="setAccelRange(16)">¬±16g</button>
          </div>
        </div>

        <div class="quick-group">
          <label class="quick-label">Gyroscope Range</label>
          <div class="action-buttons">
            <button data-gyro="250" onclick="setGyroRange(250)">¬±250¬∞/s</button>
            <button data-gyro="500" onclick="setGyroRange(500)">¬±500¬∞/s</button>
            <button data-gyro="1000" onclick="setGyroRange(1000)">¬±1000¬∞/s</button>
            <button data-gyro="2000" onclick="setGyroRange(2000)">¬±2000¬∞/s</button>
          </div>
        </div>

        <div class="quick-group">
          <label class="quick-label">DLPF & Sample Rate</label>
          <div class="action-buttons">
            <button data-dlpf="3" onclick="setDLPF(3)">DLPF 41Hz</button>
            <button data-dlpf="2" onclick="setDLPF(2)">DLPF 92Hz</button>
            <button data-dlpf="1" onclick="setDLPF(1)">DLPF 184Hz</button>
            <button data-dlpf="0" onclick="setDLPF(0)">DLPF 250Hz</button>
            <button data-dlpf="4" onclick="setDLPF(4)">DLPF 20Hz</button>
            <button data-dlpf="5" onclick="setDLPF(5)">DLPF 10Hz</button>
            <button data-dlpf="6" onclick="setDLPF(6)">DLPF 5Hz</button>
            <button data-srate="100" onclick="setSampleRate(100)">SR 100Hz</button>
            <button data-srate="200" onclick="setSampleRate(200)">SR 200Hz</button>
            <button data-srate="500" onclick="setSampleRate(500)">SR 500Hz</button>
            <button data-srate="1000" onclick="setSampleRate(1000)">SR 1000Hz</button>
          </div>
        </div>

        <div class="quick-group">
          <label class="quick-label">Magnetometer Resolution</label>
          <div class="action-buttons">
            <button data-magres="14" onclick="setMagResolution(14)">Mag 14-bit</button>
            <button data-magres="16" onclick="setMagResolution(16)">Mag 16-bit</button>
          </div>
        </div>
      </div>

      <!-- Register Table -->
      <div class="table-container">
        <h2>üìã <span id="register-heading">MPU9250 Registers (0x00-0x7F)</span></h2>
        <table>
          <thead>
            <tr>
              <th>Address</th>
              <th>Register</th>
              <th>Description</th>
              <th>Value (hex)</th>
              <th>Access</th>
            </tr>
          </thead>
          <tbody id="register-table">
            <tr>
              <td colspan="5" style="text-align: center; padding: 2rem;">
                <span style="color: var(--muted);">Click "Read All Registers" to populate table</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let currentDevice = 'left';
    let currentRegisterDevice = 'mpu9250';
    let registerMap = [];
    const registerValuesByDevice = { mpu9250: {}, ak8963: {} };
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    let liveDataTimer = null;
    const LIVE_POLL_MS = 500;
    const accelSensitivity = { 2: 16384, 4: 8192, 8: 4096, 16: 2048 };
    const gyroSensitivity = { 250: 131, 500: 65.5, 1000: 32.8, 2000: 16.4 };
    let currentAccelRangeG = 8;
    let currentGyroRangeDps = 500;

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      
      // Backend serves WebSocket at /ws on port 8081
      let host = window.location.host;
      if (window.location.port && window.location.port !== '8081') {
        // If we're not on port 8081, connect to 8081
        const hostname = window.location.hostname;
        host = `${hostname}:8081`;
      }
      
      const url = `${protocol}//${host}/ws`;
      
      console.log(`Attempting WebSocket connection to: ${url}`);
      updateStatus(`Connecting to ${host}...`, false);
      
      ws = new WebSocket(url);
      
      ws.onopen = () => {
        updateStatus('Connected', true);
        console.log('WebSocket connected successfully');
        reconnectAttempts = 0;
        // Request register map explicitly in case the initial push was missed
        sendWebSocketMessage({ action: 'get_map', device: currentRegisterDevice });
        // Populate values on connect
        readAllRegisters();
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleWebSocketMessage(msg);
        } catch (err) {
          console.error('WebSocket message parse error:', err);
        }
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        updateStatus('Connection Failed - Backend Not Running', false);
      };

      ws.onclose = () => {
        updateStatus('Disconnected', false);
        console.log('WebSocket disconnected');
        
        reconnectAttempts++;
        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
          console.log(`Reconnection attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} in ${delay}ms`);
          setTimeout(connectWebSocket, delay);
        } else {
          updateStatus('Connection Failed - Check if register_debug server is running on port 8081', false);
        }
      };
    }

    function handleWebSocketMessage(msg) {
      if (msg.type === 'register_data') {
        const device = (msg.device === 'mpu9250' || msg.device === 'ak8963') ? msg.device : currentRegisterDevice;
        if (msg.registers) {
          // Bulk read response
          registerValuesByDevice[device] = normalizeRegisterValues(msg.registers);
          syncQuickConfigFromRegisters(device);
          renderRegisterTable();
        } else if (msg.addr && msg.value !== undefined) {
          // Single register update
          updateRegisterRow(msg.addr, msg.value, device);
          syncQuickConfigFromRegisters(device);
        }
      } else if (msg.type === 'register_map') {
        registerMap = msg.register_map || [];
        renderRegisterTable();
      } else if (msg.type === 'sensor_data') {
        updateLiveSensorData(msg);
      } else if (msg.type === 'status') {
        console.log('Status:', msg);
      } else if (msg.type === 'error') {
        console.error('Server error:', msg.message);
      }
    }

    function updateStatus(text, isConnected) {
      const statusEl = document.getElementById('status');
      const diagPanel = document.getElementById('diagnostic-panel');
      statusEl.textContent = text;
      statusEl.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
      
      // Show diagnostic panel if connection failed
      if (!isConnected && text.includes('Failed')) {
        diagPanel.style.display = 'block';
      } else {
        diagPanel.style.display = 'none';
      }
    }

    function updateLiveSensorData(msg) {
      const accel = msg.accel || { x: msg.ax, y: msg.ay, z: msg.az };
      const gyro = msg.gyro || { x: msg.gx, y: msg.gy, z: msg.gz };
      const mag = msg.mag || { x: msg.mx, y: msg.my, z: msg.mz };

      document.getElementById('accel-x').textContent = formatAxis(accel.x);
      document.getElementById('accel-y').textContent = formatAxis(accel.y);
      document.getElementById('accel-z').textContent = formatAxis(accel.z);

      document.getElementById('accel-x-g').textContent = formatAxis(toG(accel.x));
      document.getElementById('accel-y-g').textContent = formatAxis(toG(accel.y));
      document.getElementById('accel-z-g').textContent = formatAxis(toG(accel.z));

      document.getElementById('gyro-x').textContent = formatAxis(gyro.x);
      document.getElementById('gyro-y').textContent = formatAxis(gyro.y);
      document.getElementById('gyro-z').textContent = formatAxis(gyro.z);

      document.getElementById('gyro-x-dps').textContent = formatAxis(toDps(gyro.x));
      document.getElementById('gyro-y-dps').textContent = formatAxis(toDps(gyro.y));
      document.getElementById('gyro-z-dps').textContent = formatAxis(toDps(gyro.z));

      document.getElementById('mag-x').textContent = formatAxis(mag.x);
      document.getElementById('mag-y').textContent = formatAxis(mag.y);
      document.getElementById('mag-z').textContent = formatAxis(mag.z);

      document.getElementById('mag-x-ut').textContent = formatAxis(toMicroTesla(mag.x));
      document.getElementById('mag-y-ut').textContent = formatAxis(toMicroTesla(mag.y));
      document.getElementById('mag-z-ut').textContent = formatAxis(toMicroTesla(mag.z));

      const magMagnitude = computeMagnitude(mag.x, mag.y, mag.z);
      document.getElementById('mag-magnitude').textContent = magMagnitude ?? '---';
    }

    function formatAxis(value) {
      return value === undefined || value === null ? '---' : value;
    }

    function computeMagnitude(x, y, z) {
      if ([x, y, z].some((v) => v === undefined || v === null)) {
        return null;
      }
      const fx = Number(x);
      const fy = Number(y);
      const fz = Number(z);
      if ([fx, fy, fz].some((v) => Number.isNaN(v))) {
        return null;
      }
      return Math.sqrt(fx * fx + fy * fy + fz * fz).toFixed(1);
    }

    function toG(raw) {
      if (raw === undefined || raw === null) return null;
      const sens = accelSensitivity[currentAccelRangeG] || 4096;
      return (Number(raw) / sens).toFixed(3);
    }

    function toDps(raw) {
      if (raw === undefined || raw === null) return null;
      const sens = gyroSensitivity[currentGyroRangeDps] || 65.5;
      return (Number(raw) / sens).toFixed(3);
    }

    function toMicroTesla(raw) {
      if (raw === undefined || raw === null) return null;
      return (Number(raw) / 10).toFixed(1);
    }

    function sendWebSocketMessage(msg) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('WebSocket not connected');
        return;
      }
      msg.imu = currentDevice;  // Backend expects 'imu' field, not 'device'
      ws.send(JSON.stringify(msg));
    }

    function readAllRegisters() {
      sendWebSocketMessage({ action: 'read_all', device: currentRegisterDevice });
    }

    function reinitializeIMU() {
      if (confirm('Reinitialize ' + currentDevice + ' IMU?')) {
        sendWebSocketMessage({ action: 'init' });
      }
    }

    function deviceChanged() {
      currentDevice = document.getElementById('device-select').value;
      registerValuesByDevice.mpu9250 = {};
      registerValuesByDevice.ak8963 = {};
      document.getElementById('register-table').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;"><span style="color: var(--muted);">Click "Read All Registers" to populate table</span></td></tr>';
      startLiveDataPolling();
    }

    function registerDeviceChanged() {
      currentRegisterDevice = document.getElementById('register-device-select').value;
      registerValuesByDevice[currentRegisterDevice] = registerValuesByDevice[currentRegisterDevice] || {};
      document.getElementById('register-table').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;"><span style="color: var(--muted);">Click "Read All Registers" to populate table</span></td></tr>';
      updateRegisterHeading();
      sendWebSocketMessage({ action: 'get_map', device: currentRegisterDevice });
      readAllRegisters();
    }

    function renderRegisterTable() {
      const tbody = document.getElementById('register-table');
      tbody.innerHTML = '';

      if (!registerMap || registerMap.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;"><span style="color: var(--muted);">No register map available</span></td></tr>';
        return;
      }

      const registerValues = registerValuesByDevice[currentRegisterDevice] || {};

      registerMap.forEach((reg) => {
        const addr = typeof reg.address === 'string' ? reg.address : '0x' + reg.address.toString(16).toUpperCase().padStart(2, '0');
        const value = registerValues[addr] ?? registerValues[parseInt(addr, 16)] ?? 0;
        const hexValue = '0x' + (value & 0xFF).toString(16).toUpperCase().padStart(2, '0');
        const writable = reg.access && reg.access.includes('W');

        const tr = document.createElement('tr');

        let bitFieldsHTML = '';
        if (reg.bit_fields && reg.bit_fields.length > 0) {
          bitFieldsHTML = '<div class="bit-fields">';
          bitFieldsHTML += '<div class="bit-fields-title">Bit Fields:</div>';
          reg.bit_fields.forEach(bf => {
            bitFieldsHTML += '<div class="bit-field-item">';
            bitFieldsHTML += `<span class="bit-field-bits">${bf.bits}</span>`;
            bitFieldsHTML += `<span class="bit-field-name">${bf.name}</span>`;
            if (bf.description) {
              bitFieldsHTML += `<div class="bit-field-desc">${bf.description}</div>`;
            }
            bitFieldsHTML += '</div>';
          });
          bitFieldsHTML += '</div>';
        }

        tr.innerHTML = `
          <td class="reg-addr">${addr}</td>
          <td>
            <div class="reg-name">${reg.name}</div>
            ${bitFieldsHTML}
          </td>
          <td class="reg-desc">${reg.description}</td>
          <td class="reg-value">${hexValue}</td>
          <td>
            <span class="reg-access ${writable ? 'writable' : 'read-only'}">
              ${reg.access}
            </span>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function updateRegisterRow(addr, value, device) {
      // Simple refresh path: update cache and re-render row set for consistency
      const parsed = typeof value === 'string' ? parseInt(value, 16) : Number(value) || 0;
      const dev = (device === 'mpu9250' || device === 'ak8963') ? device : currentRegisterDevice;
      registerValuesByDevice[dev] = registerValuesByDevice[dev] || {};
      registerValuesByDevice[dev][addr.startsWith('0x') ? addr.toUpperCase() : addr] = parsed;
      renderRegisterTable();
    }

    function normalizeRegisterValues(rawMap) {
      const normalized = {};
      Object.entries(rawMap || {}).forEach(([addr, value]) => {
        const addrKey = addr.startsWith('0x') ? addr.toUpperCase() : '0x' + Number(addr).toString(16).toUpperCase().padStart(2, '0');
        const parsedValue = typeof value === 'string' ? parseInt(value, 16) : Number(value) || 0;
        normalized[addrKey] = parsedValue;
        normalized[parseInt(addrKey, 16)] = parsedValue;
      });
      return normalized;
    }

    function markActive(group, targetValue) {
      document.querySelectorAll(`[data-${group}]`).forEach((btn) => {
        const val = btn.getAttribute(`data-${group}`);
        btn.classList.toggle('active', Number(val) === Number(targetValue));
      });
    }

    function syncQuickConfigFromRegisters(device) {
      if (device === 'mpu9250') {
        const regs = registerValuesByDevice.mpu9250 || {};
        const accelCfg = regs['0x1C'];
        if (accelCfg !== undefined) {
          const shift = (accelCfg >> 3) & 0x03;
          const range = { 0: 2, 1: 4, 2: 8, 3: 16 }[shift] || currentAccelRangeG;
          currentAccelRangeG = range;
          document.getElementById('accel-range').textContent = `¬±${range}g`;
          markActive('accel', range);
        }

        const gyroCfg = regs['0x1B'];
        if (gyroCfg !== undefined) {
          const shift = (gyroCfg >> 3) & 0x03;
          const range = { 0: 250, 1: 500, 2: 1000, 3: 2000 }[shift] || currentGyroRangeDps;
          currentGyroRangeDps = range;
          document.getElementById('gyro-range').textContent = `¬±${range}¬∞/s`;
          markActive('gyro', range);
        }

        const dlpfCfg = regs['0x1A'];
        if (dlpfCfg !== undefined) {
          const cfg = dlpfCfg & 0x07;
          markActive('dlpf', cfg);
        }

        const smplrt = regs['0x19'];
        if (smplrt !== undefined) {
          const base = 1000; // with DLPF enabled
          const rate = Math.round(base / (1 + smplrt));
          markActive('srate', rate);
        }
      } else if (device === 'ak8963') {
        const regs = registerValuesByDevice.ak8963 || {};
        const cntl1 = regs['0x0A'];
        if (cntl1 !== undefined) {
          const bits = (cntl1 & 0x10) ? 16 : 14;
          markActive('magres', bits);
        }
      }
    }

    function setAccelRange(rangeG) {
      currentAccelRangeG = rangeG;
      document.getElementById('accel-range').textContent = `¬±${rangeG}g`;
      markActive('accel', rangeG);
      // ACCEL_CONFIG (0x1C): bits[4:3] set range
      const shift = { 2: 0, 4: 1, 8: 2, 16: 3 }[rangeG] ?? 2;
      const value = (shift << 3) & 0x18;
      sendWebSocketMessage({ action: 'write', device: 'mpu9250', addr: '0x1C', value: `0x${value.toString(16).toUpperCase().padStart(2, '0')}` });
    }

    function setGyroRange(rangeDps) {
      currentGyroRangeDps = rangeDps;
      document.getElementById('gyro-range').textContent = `¬±${rangeDps}¬∞/s`;
      markActive('gyro', rangeDps);
      // GYRO_CONFIG (0x1B): bits[4:3]
      const shift = { 250: 0, 500: 1, 1000: 2, 2000: 3 }[rangeDps] ?? 1;
      const value = (shift << 3) & 0x18;
      sendWebSocketMessage({ action: 'write', device: 'mpu9250', addr: '0x1B', value: `0x${value.toString(16).toUpperCase().padStart(2, '0')}` });
    }

    function setDLPF(cfg) {
      // CONFIG (0x1A): bits[2:0] DLPF_CFG
      const value = cfg & 0x07;
      markActive('dlpf', cfg);
      sendWebSocketMessage({ action: 'write', device: 'mpu9250', addr: '0x1A', value: `0x${value.toString(16).toUpperCase().padStart(2, '0')}` });
    }

    function setSampleRate(targetHz) {
      // SMPLRT_DIV (0x19): sample_rate = gyro_output_rate / (1 + div), gyro_output_rate=1kHz when DLPF on
      const base = 1000;
      const divider = Math.max(0, Math.round((base / targetHz) - 1));
      const clamped = Math.min(255, divider);
      markActive('srate', Math.round(base / (clamped + 1)));
      sendWebSocketMessage({ action: 'write', device: 'mpu9250', addr: '0x19', value: `0x${clamped.toString(16).toUpperCase().padStart(2, '0')}` });
    }

    function setMagResolution(bits) {
      // AK8963 CNTL1 (0x0A): 0x12 = 14-bit continuous mode 2 (100Hz), 0x16 = 16-bit continuous mode 2 (100Hz)
      const value = bits === 14 ? 0x12 : 0x16;
      markActive('magres', bits === 14 ? 14 : 16);
      sendWebSocketMessage({ action: 'write', device: 'ak8963', addr: '0x0A', value: `0x${value.toString(16).toUpperCase().padStart(2, '0')}` });
    }

    function fetchLiveData() {
      fetch(`/api/imu?imu=${currentDevice}`)
        .then((resp) => {
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }
          return resp.json();
        })
        .then((data) => updateLiveSensorData(data))
        .catch((err) => console.warn('Live data fetch failed:', err));
    }

    function startLiveDataPolling() {
      if (liveDataTimer) {
        clearInterval(liveDataTimer);
      }
      fetchLiveData();
      liveDataTimer = setInterval(fetchLiveData, LIVE_POLL_MS);
    }

    // Initialize WebSocket connection on page load
    window.addEventListener('load', () => {
      connectWebSocket();
      startLiveDataPolling();
      updateRegisterHeading();
    });

    function updateRegisterHeading() {
      const heading = document.getElementById('register-heading');
      heading.textContent = currentRegisterDevice === 'ak8963'
        ? 'AK8963 Registers (0x00-0x0F)'
        : 'MPU9250 Registers (0x00-0x7F)';
    }
  </script>
</body>
</html>
